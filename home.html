<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORZA4 - Dashboard</title>
    <link rel="stylesheet" href="assets/style/style.css">
</head>

<body>
    <div class="container dashboard-container">
        <header class="dashboard-header">
            <h1>FORZA4</h1>
            <div id="user-controls">
                <!-- Will be populated by JS -->
            </div>
        </header>

        <!-- Auth Section (Hidden by default) -->
        <div id="auth-section" class="hidden overlay-panel">
            <button class="close-btn" onclick="toggleAuth()">X</button>
            <div class="auth-box">
                <h2>Login</h2>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Username" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="reset-btn">Login</button>
                </form>
                <p class="auth-switch">New here? <a href="#" id="show-register">Register</a></p>
            </div>

            <div class="auth-box hidden" id="register-box">
                <h2>Register</h2>
                <form id="register-form">
                    <input type="text" id="reg-username" placeholder="Username" required>
                    <input type="password" id="reg-password" placeholder="Password" required>

                    <label style="color: #fff; font-size: 0.7rem; display: block; margin-bottom: 10px;">Select
                        Avatar:</label>
                    <div class="avatar-grid">
                        <div class="avatar-option selected" data-type="image" data-value="assets/img/avatars/robot.png"
                            style="background-image: url('assets/img/avatars/robot.png');"></div>
                        <div class="avatar-option" data-type="image" data-value="assets/img/avatars/ninja.png"
                            style="background-image: url('assets/img/avatars/ninja.png');"></div>
                        <div class="avatar-option" data-type="color" data-value="#e74c3c"
                            style="background-color: #e74c3c;"></div>
                        <div class="avatar-option" data-type="color" data-value="#f1c40f"
                            style="background-color: #f1c40f;"></div>
                        <div class="avatar-option" data-type="color" data-value="#3498db"
                            style="background-color: #3498db;"></div>
                        <div class="avatar-option" data-type="color" data-value="#9b59b6"
                            style="background-color: #9b59b6;"></div>
                    </div>
                    <input type="hidden" id="reg-pfp-type" value="image">
                    <input type="hidden" id="reg-pfp-value" value="assets/img/avatars/robot.png">

                    <button type="submit" class="reset-btn">Register</button>
                </form>
                <p class="auth-switch">Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
            <div id="auth-message" class="message"></div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard-section">
            <div class="game-modes">
                <h3>Select Game Mode</h3>
                <div class="mode-cards">
                    <div class="mode-card" onclick="startGame('pvp')">
                        <h4>Local PvP</h4>
                        <p>Play against a friend on this device.</p>
                    </div>
                    <div class="mode-card" onclick="startGame('pvcpu')">
                        <h4>PvCPU</h4>
                        <p>Challenge the AI computer.</p>
                    </div>
                    <div class="mode-card disabled">
                        <h4>Online PvP</h4>
                        <p>Login required for Online play.</p>
                    </div>
                </div>
            </div>

            <div class="settings-area">
                <button class="mode-btn" onclick="toggleSettings()">Settings</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'api.php';
        let currentUser = null;

        // Check for logged in user
        const savedUser = localStorage.getItem('forza4_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
        }

        updateUserUI();

        function updateUserUI() {
            const controls = document.getElementById('user-controls');
            if (currentUser) {
                let pfpStyle = '';
                if (currentUser.pfp.type === 'color') {
                    pfpStyle = `background-color: ${currentUser.pfp.value}`;
                } else {
                    pfpStyle = `background-image: url('${currentUser.pfp.value}'); background-size: cover; background-position: center;`;
                }

                controls.innerHTML = `
                    <div class="mini-profile">
                        <div class="pfp-small" style="${pfpStyle}"></div>
                        <span>${currentUser.username}</span>
                        <button onclick="logout()" class="reset-btn small-btn">Logout</button>
                    </div>
                `;
            } else {
                controls.innerHTML = `
                    <button onclick="toggleAuth()" class="reset-btn">Login / Register</button>
                `;
            }
        }

        function toggleAuth() {
            const authSection = document.getElementById('auth-section');
            authSection.classList.toggle('hidden');
        }

        function toggleSettings() {
            alert("Settings menu coming soon!");
        }

        // Auth Logic
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('auth-section').querySelector('.auth-box').classList.add('hidden');
            document.getElementById('register-box').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-box').classList.add('hidden');
            document.getElementById('auth-section').querySelector('.auth-box').classList.remove('hidden');
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const formData = new FormData();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('forza4_user', JSON.stringify(currentUser));
                    updateUserUI();
                    toggleAuth();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (err) {
                showMessage('Connection error', 'error');
            }
        });

        // Avatar Selection Logic
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                document.getElementById('reg-pfp-type').value = opt.dataset.type;
                document.getElementById('reg-pfp-value').value = opt.dataset.value;
            });
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const pfpType = document.getElementById('reg-pfp-type').value;
            const pfpValue = document.getElementById('reg-pfp-value').value;

            const formData = new FormData();
            formData.append('action', 'register');
            formData.append('username', username);
            formData.append('password', password);
            formData.append('pfp_type', pfpType);
            formData.append('pfp_value', pfpValue);

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('forza4_user', JSON.stringify(currentUser));
                    updateUserUI();
                    toggleAuth();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (err) {
                showMessage('Connection error', 'error');
            }
        });

        function logout() {
            localStorage.removeItem('forza4_user');
            currentUser = null;
            updateUserUI();
        }

        function showMessage(msg, type) {
            const el = document.getElementById('auth-message');
            el.textContent = msg;
            el.className = `message ${type}`;
        }

        function startGame(mode) {
            if (mode === 'online' && !currentUser) {
                alert("Please login to play online!");
                toggleAuth();
                return;
            }
            localStorage.setItem('forza4_gameMode', mode);
            window.location.href = 'game.html';
        }
    </script>
</body>

</html>